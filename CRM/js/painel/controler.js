const controler={async updateInbox(){document.querySelector('div[tag="inbox-empty"]')?.remove();let t=document.querySelector(".inbox"),a=t.querySelectorAll(".user"),r=await WPP("getListContact"),o=await GFN.getStorage("userTabs"),s=o.userTabs.flatMap(t=>t.chats.map(t=>t.id)),l=await GFN.getStorage("crm_peformace");l=l.crm_peformace;let i=0,n=!0;for(let c=0;c<r.length;c++){let u=r[c];if(!s.includes(u.id)){if(a[i]){let d=a[i].getAttribute("userID");u.id!=d&&(a[i].setAttribute("userID",u.id),ACTION.labels(a[i].querySelector('div[tag="userLabels"]'),u.labels),ACTION.picture(a[i].querySelector(".camp1"),u.picture,u.id),ACTION.nome(a[i].querySelector('h1[tag="userName"]'),u.name,u.id)),n=!1}else showUser(t,"after",u.id,u.picture,u.labels,u.name,!1,"inbox"),n=!1;if(i+1==l.inbox)return;i++}}if(n){document.querySelector(".inbox").innerHTML="";let b=document.createElement("div");b.setAttribute("tag","inbox-empty"),t.appendChild(b);let g=document.createElement("p");g.innerHTML="Todas as suas conversas recentes se encontrarm presentes em abas",b.appendChild(g)}},async abaListUpdate(t){let a=document.querySelector(`div[aba-id="${t.toLowerCase()}"]`);if(!a)return;let r=await GFN.getStorage("userTabs"),o=(r=r.userTabs).find(a=>a.tag==t);o=o.chats,a.querySelector('span[tag="tam-aba"]').innerHTML=o.length,controler.listControler(a.querySelector(".list-contatos"),o),document.querySelector(".inbox").innerHTML="",controler.updateInbox()},insertUserAba(t,a,r){let o=document.querySelector(`div[aba-id="${t.toLowerCase()}"]`);if(!o)return;console.log(r),showUser(o.querySelector(".list-contatos"),"before",a,r.picture,r.etiqueta,r.name,r.dataEntrada);let s=o.querySelector('span[tag="tam-aba"]');s.innerHTML=parseInt(s.innerHTML)+1,controler.updateInbox()},removeUserAba(t,a){let r=document.querySelector(`div[aba-id="${t.toLowerCase()}"]`);if(!r)return;let o=r.querySelector(".list-contatos"),s=o.querySelector(`div[userid="${a}"]`);if(console.log(s),!s)return;s?.remove();let l=r.querySelector('span[tag="tam-aba"]');l.innerHTML=parseInt(l.innerHTML)-1,controler.updateInbox()},async listControler(t,a){let r=await GFN.getStorage("crm_peformace"),o=(r=r.crm_peformace).abas,s=1;t.innerHTML="";let l={show(a){for(let r of a)showUser(t,"after",r.id,r.picture,r.etiqueta,r.name,r.dataEntrada);l.carregarMais()},carregarMais(){if(o*s<a.length){let r=document.createElement("button");r.setAttribute("tag","load-contatos"),r.classList.add("load-contatos"),r.innerHTML="Carregar mais",r.addEventListener("click",()=>{l.listMais(r)}),t.appendChild(r)}},listMais(t){let r=a.slice(o*s,o*(s+1));console.log(a),console.log(r),t?.remove(),s++,l.show(r)}};l.show(a.slice(0,o))},abaAdd(t){let a=document.querySelector(".content"),r=document.createElement("div");r.classList.add("aba-Content"),r.setAttribute("aba-id",t.tag.toLowerCase()),r.setAttribute("data-id",t.tag.toLowerCase()),a.appendChild(r),injectPainel.header(r,!1,t.tag,t.chats.length);let o=document.createElement("div");o.classList.add("list-contatos"),r.appendChild(o),controler.listControler(o,t.chats),controler.sortableAbasUsers(o)},abaUpdate(t,a){let r=document.querySelector(`div[aba-id="${t.toLowerCase()}"]`);if(!r)return;r.setAttribute("aba-id",a.toLowerCase()),r.setAttribute("data-id",a.toLowerCase()),r.querySelector(".list-contatos").setAttribute("list-users",a.toLowerCase());let o=r.querySelector("h2[aba-name]");a.length>18?o.innerHTML=a.slice(0,15)+"...":o.innerHTML=a},abaRemove(t){let a=document.querySelector(`div[aba-id="${t.toLowerCase()}"]`);a?.remove(),controler.updateInbox()},async etiquetaUpdate(t,a,r){GFN.labels=await WPP("labels");let o=document.querySelectorAll(`div[userid="${t}"]`);0!=o.length&&(o.forEach(r=>{$(r).find('div[tag="userLabels"]').off(),ACTION.labels(r,r.querySelector('div[tag="userLabels"]'),t,a)}),console.log(a),r&&document.querySelector(`#modalEtiqueta[tag="${t}"]`)&&(document.querySelector("#modalEtiqueta")?.remove(),labelsEdit(e=!1,o[0],o[0].querySelector('div[tag="userLabels"]'),t,a)))},async pesquisar(t,a,r,o,s){t.classList.add("d-none"),o.classList.add("d-none"),a.setAttribute("style","justify-content: flex-start;");let l=s.getAttribute("aba-id"),i=s.querySelector(".list-contatos"),n=document.createElement("input");n.setAttribute("style","max-width: 175px;height: 23px;background-color: #ffffff2e;"),n.setAttribute("tag","pesquisar-abas"),a.appendChild(n),n.focus();let c=document.createElement("span");c.setAttribute("tag","close-pesquisar-abas"),a.appendChild(c),GFN.svg(c,"./img/close.svg"),c.addEventListener("click",async()=>{t.classList.remove("d-none"),o.classList.remove("d-none"),a.removeAttribute("style"),n?.remove(),c?.remove();let u=await GFN.getStorage("userTabs"),d=(u=u.userTabs).find(t=>t.tag.toLowerCase()==l);d=d.chats,controler.listControler(i,d),$(r).one("click",()=>{controler.pesquisar(t,a,r,o,s)})}),n.addEventListener("keyup",async()=>{let t=await GFN.getStorage("userTabs"),a=(t=t.userTabs).find(t=>t.tag.toLowerCase()==l);a=a.chats;let r=[];for(let o of a)o.name&&o.name.toLowerCase().includes(n.value.toLowerCase())&&r.push(o);controler.listControler(i,r)})},sortableAbas(t){new Sortable(t,{group:{name:"abas",pull:"clone",put:!1},animation:150,onEnd:function(t){var a=document.querySelector("[data-id='inbox']");0!==Array.from(this.el.children).indexOf(a)&&this.el.insertBefore(a,this.el.children[0])},onSort:async function(t){let a=await GFN.getStorage("userTabs");a=a.userTabs,await GFN.aguarde(200);var r=this.toArray();r.shift(),console.log(r);let o={};for(let s=0;s<a.length;s++)o[a[s].tag.toLowerCase()]=s;console.log(o);let l=[];for(let i of r)console.log(o[i]),void 0!==o[i]&&l.push(a[o[i]]);chrome.storage.local.set({userTabs:l}),console.log(l)}})},sortableInboxUsers(t){new Sortable(t,{group:{name:"shared",pull:"shared",put:!1},animation:150,sort:!1,onEnd:function(t){var a=t.item,r=t.from,o=t.to;r!==o&&controler.userMoveAbas(a,r,o)}})},sortableAbasUsers(t){let a=!1,r=!1,o=!1;t.addEventListener("mousedown",function(t){0===t.button?a=!0:2===t.button&&(r=!0),o=!1,a&&r&&(console.log("Ambos os bot\xf5es do mouse est\xe3o pressionados"),a=!1,r=!1,o=!0)}),t.addEventListener("mouseup",function(t){0===t.button?a=!1:2===t.button&&(r=!1),o=!1}),new Sortable(t,{cancel:".ui-state-disabled:not(.sortable)",group:"shared",filter:".load-contatos",animation:150,onMove:function(t){return!t.dragged.classList.contains("load-contatos")&&(!t.related.classList.contains("load-contatos")||!t.willInsertAfter)},onEnd:function(t){var a=t.item,r=t.from,s=t.to;r!==s&&controler.userMoveAbas(a,r,s,o)}})},async userMoveAbas(t,a,r,o){if(await GFN.isFree()){GFN.modal_CRM_Free();return}let s=t;t=t.getAttribute("userid"),a=a.getAttribute("list-users"),r=r.getAttribute("list-users"),console.log("Elemento arrastado:",t),console.log("Lista de origem:",a),console.log("Lista de destino:",r),console.log("Db_click",o);let l=await GFN.getStorage("userTabs");l=l.userTabs;let i={copy(){let o=l.find(t=>t.tag.toLowerCase()===a)?.chats.find(a=>a.id===t);console.log(o);for(let s=0;s<l.length;s++)if(l[s].tag.toLowerCase()==r){let i=l[s].chats.find(t=>t.id==o.id);if(console.log(i),i){controler.listControler(document.querySelector(`div[list-users="${a}"]`),l.find(t=>t.tag.toLowerCase()===a).chats),controler.listControler(document.querySelector(`div[list-users="${r}"]`),l.find(t=>t.tag.toLowerCase()===r).chats),GFN.notificacao("error","Este usu\xe1rio j\xe1 existe na aba selecionada.");return}l[s].chats.unshift(o),chrome.storage.local.set({userTabs:l}),Content("atualizarAbas");let n=document.querySelector(`div[aba-id="${r}"] > .aba-header > .aba-nomeAba > span`);n.innerHTML=parseInt(n.innerHTML)+1,controler.listControler(document.querySelector(`div[list-users="${a}"]`),l.find(t=>t.tag.toLowerCase()===a).chats),console.log(o),controler.updateUser(t,o)}},async recortar(){let o="",s=[];for(let i=0;i<l.length;i++)l[i].tag.toLowerCase()==a&&(l[i].chats.forEach(a=>{a.id!=t?s.push(a):o=a}),l[i].chats=s);for(let n=0;n<l.length;n++)if(l[n].tag.toLowerCase()==r){if(l[n].chats.find(t=>t.id==o.id)){let c=await GFN.getStorage("userTabs");c=c.userTabs,controler.listControler(document.querySelector(`div[list-users="${a}"]`),c.find(t=>t.tag.toLowerCase()===a).chats),controler.listControler(document.querySelector(`div[list-users="${r}"]`),c.find(t=>t.tag.toLowerCase()===r).chats),GFN.notificacao("error","Este usu\xe1rio j\xe1 existe na aba selecionada.");return}l[n].chats.unshift(o)}chrome.storage.local.set({userTabs:l}),Content("atualizarAbas");let u=document.querySelector(`div[aba-id="${r}"] > .aba-header > .aba-nomeAba > span`);u.innerHTML=parseInt(u.innerHTML)+1;let d=document.querySelector(`div[aba-id="${a}"] > .aba-header > .aba-nomeAba > span`);d.innerHTML=parseInt(d.innerHTML)-1,controler.updateUser(t,o)},async inbox(){let a=await WPP("getListContact"),o="";for(let i of a)if(i.id==t){o=i;break}o={dataEntrada:Date.now(),etiqueta:o.labels,id:o.id,name:o.name,picture:o.picture},console.log(o);for(let n=0;n<l.length;n++)if(l[n].tag.toLowerCase()==r){if(l[n].chats.find(t=>t.id==o.id)){controler.listControler(document.querySelector(`div[list-users="${r}"]`),l.find(t=>t.tag.toLowerCase()===r).chats),GFN.notificacao("error","Este usu\xe1rio j\xe1 existe na aba selecionada."),controler.updateInbox();return}l[n].chats.unshift(o),controler.updateInbox()}chrome.storage.local.set({userTabs:l}),Content("atualizarAbas");let c=document.querySelector(`div[aba-id="${r}"] > .aba-header > .aba-nomeAba > span`);c.innerHTML=parseInt(c.innerHTML)+1,console.log(s.querySelectorAll(".d-none")),s.querySelectorAll(".d-none").forEach(t=>{t.classList.remove("d-none")}),controler.updateUser(t,o)}};switch(o){case!0:i.copy();break;case!1:i.recortar();break;default:i.inbox()}},async updateUser(t,a){notas_agendamentos={agendamentos:await getAgendamentos(),notas:await getNotas()};let r=t.length>15?t+"@g.us":t+"@c.us",o=await WPP("getContato",t),s={id:t,picture:await WPP("getPicture",{num:r}),name:o.name,dataEntrada:a.dataEntrada||Date.now(),etiqueta:o.labels};console.log(s),usersUpdate.push(s),document.querySelectorAll(`div[userid="${t}"]`).forEach(r=>{ACTION.labels(r,r.querySelector('div[tag="userLabels"]'),t,o.labels),ACTION.picture(r.querySelector(".camp1"),s.picture,s.id),ACTION.nome(r.querySelector('h1[tag="userName"]'),s.name,s.id),ACTION.data(r.querySelector('div[tag="UserDateCRM"]'),a.dataEntrada),ACTION.notas(r.querySelector(".guardado"),t),ACTION.agendamentos(r.querySelector(".guardado"),t)})},async saveUpdateUsers(t){if(0==t.length)return;let a=await GFN.getStorage("userTabs");for(let r of(a=a.userTabs,t))a.forEach(t=>{let a=t.chats.findIndex(t=>t.id===r.id);-1!==a&&(t.chats[a]=r,console.log(t.chats[a]))});chrome.storage.local.set({userTabs:a}),usersUpdate.splice(0,usersUpdate.length),console.log(a)},async userRemove(t,a){t.stopPropagation();let r=a.attributes[0].ownerElement.parentElement.getAttribute("list-users"),o=a.getAttribute("userid"),s=await GFN.getStorage("userTabs");s=s.userTabs;for(let l=0;l<s.length;l++)if(s[l].tag.toLowerCase()==r){let i=s[l].chats.filter(t=>t.id!=o);s[l].chats=i,console.log(i)}console.log(s),chrome.storage.local.set({userTabs:s}),controler.removeUserAba(r,o),GFN.notificacao("success",GFN.language.CRM_removerUserSuccess)},async userUpdateNome(t){let a=await GFN.getStorage("userTabs");a=a.userTabs,console.log(a);let r=a.some(a=>a.chats.some(a=>a.id===t.id));if(r){for(let o of a)o.chats.forEach(a=>{a.id===t.id&&(a.name=t.name)});chrome.storage.local.set({userTabs:a})}let s=document.querySelectorAll(`div[userid="${t.id}"]`);s.forEach(a=>{a.querySelector("h1").innerHTML=t.name})},async updateContNotas(t){let a=document.querySelectorAll(`div[userid="${t}"]`);notas_agendamentos={agendamentos:await getAgendamentos(),notas:await getNotas()};let r=notas_agendamentos.agendamentos.find(a=>a.userID==t),o=notas_agendamentos.notas.find(a=>a.userID==t);console.log(r),console.log(o),a.forEach(t=>{r?t.querySelector('div[tag="agendamentos"]')?.classList.add("activeInfo"):t.querySelector('div[tag="agendamentos"]')?.classList.remove("activeInfo"),o?t.querySelector('div[tag="notas"]')?.classList.add("activeInfo"):t.querySelector('div[tag="notas"]')?.classList.remove("activeInfo")})}};